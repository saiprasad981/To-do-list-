<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Firebase To‑Do (Single File)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 24px; display: grid; place-items: start center; }
    .app { width: 100%; max-width: 640px; }
    h1 { margin: 0 0 16px; }
    form { display: flex; gap: 8px; margin-bottom: 16px; }
    input[type="text"] { flex: 1; padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 10px 14px; border: 0; background: #4f46e5; color: #fff; border-radius: 6px; cursor: pointer; }
    button:disabled { opacity: .6; cursor: default; }
    ul { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
    li { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; }
    .title { flex: 1; }
    .done { text-decoration: line-through; opacity: .6; }
    .row { display: flex; gap: 8px; margin-bottom: 10px; }
    .danger { background: #dc2626; }
    .muted { background: #6b7280; }
    footer { margin-top: 16px; color: #666; font-size: 14px; }
    .tip { font-size: 12px; color: #666; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="app">
    <h1>To‑Do List</h1>

    <form id="add-form">
      <input id="todo-input" type="text" placeholder="Add a task..." required />
      <button id="add-btn" type="submit">Add</button>
    </form>

    <div class="row">
      <button id="show-all" class="muted" type="button">Show All</button>
      <button id="show-open" class="muted" type="button">Open Only</button>
      <button id="show-done" class="muted" type="button">Completed</button>
    </div>

    <ul id="todo-list"></ul>

    <footer>
      Real‑time sync using Firestore onSnapshot. Toggle to complete or delete tasks. [Docs referenced in code comments] [4][2]
      <div class="tip">During early development, permissive rules can be used but must be tightened before shipping. See comments below. [10][7]</div>
    </footer>
  </div>

  <script type="module">
    // Firebase (v9+ modular) via CDN. See official docs for onSnapshot, addDoc, updateDoc, deleteDoc, query, where, orderBy. [4][2]
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      onSnapshot, query, orderBy, updateDoc, deleteDoc, doc, where
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Provided config
    const firebaseConfig = {
      apiKey: "AIzaSyD4ExkZQJLgIbMEx4HTXsEp7dAR5Ue-TPM",
      authDomain: "hackathon-b062a.firebaseapp.com",
      projectId: "hackathon-b062a",
      storageBucket: "hackathon-b062a.firebasestorage.app",
      messagingSenderId: "813298313319",
      appId: "1:813298313319:web:6d2cc85a3fe7b35c668cc2",
      measurementId: "G-GH9EN3J3D4"
    };

    // Initialize app and Firestore [2]
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM refs
    const form = document.getElementById("add-form");
    const input = document.getElementById("todo-input");
    const addBtn = document.getElementById("add-btn");
    const list = document.getElementById("todo-list");
    const btnAll = document.getElementById("show-all");
    const btnOpen = document.getElementById("show-open");
    const btnDone = document.getElementById("show-done");

    let unsubscribe = null;
    let currentFilter = "ALL";

    // Add a todo [2]
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = input.value.trim();
      if (!title) return;
      addBtn.disabled = true;
      try {
        await addDoc(collection(db, "todos"), {
          title,
          completed: false,
          createdAt: serverTimestamp(),
        }); // addDoc creates an ID [2]
        input.value = "";
      } catch (err) {
        alert(err.message);
      } finally {
        addBtn.disabled = false;
      }
    });

    // Subscribe to todos with optional filters [4]
    function watchTodos(filter = "ALL") {
      if (unsubscribe) unsubscribe();

      let q = query(collection(db, "todos"), orderBy("createdAt", "desc")); // orderBy [2]
      if (filter === "OPEN") q = query(collection(db, "todos"), where("completed", "==", false), orderBy("createdAt", "desc")); // where [2]
      if (filter === "DONE") q = query(collection(db, "todos"), where("completed", "==", true), orderBy("createdAt", "desc"));  // where [2]

      unsubscribe = onSnapshot(q, (snap) => {
        list.innerHTML = "";
        snap.forEach((d) => {
          const li = document.createElement("li");
          const data = d.data();

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = !!data.completed;
          checkbox.addEventListener("change", async () => {
            try {
              await updateDoc(doc(db, "todos", d.id), { completed: checkbox.checked }); // updateDoc [2]
            } catch (err) {
              alert(err.message);
            }
          });

          const span = document.createElement("span");
          span.className = "title" + (data.completed ? " done" : "");
          span.textContent = data.title || "(untitled)";

          const del = document.createElement("button");
          del.textContent = "Delete";
          del.className = "danger";
          del.addEventListener("click", async () => {
            if (!confirm("Delete this task?")) return;
            try {
              await deleteDoc(doc(db, "todos", d.id)); // deleteDoc [2]
            } catch (err) {
              alert(err.message);
            }
          });

          li.appendChild(checkbox);
          li.appendChild(span);
          li.appendChild(del);
          list.appendChild(li);
        });
      }, (err) => {
        console.error(err);
        alert("Listener error: " + err.message);
      }); // onSnapshot real-time listener [4]
    }

    // Filter buttons
    btnAll.addEventListener("click", () => { currentFilter = "ALL"; watchTodos(currentFilter); });
    btnOpen.addEventListener("click", () => { currentFilter = "OPEN"; watchTodos(currentFilter); });
    btnDone.addEventListener("click", () => { currentFilter = "DONE"; watchTodos(currentFilter); });

    // Start
    watchTodos(currentFilter);

    /*
      Firestore rules notes:
      - For quick local prototyping you might temporarily allow reads/writes, then lock down.
      - Example structure and basics: https://cloud.google.com/firestore/native/docs/security/rules-structure [10]
      - Why not to use allow read, write: if true in production: https://dev.to/sometimescasey/firebase-cloud-firestore-permissions-don-t-do-allow-read-write-if-true-121b [7]

      Dev-only permissive rule (do NOT ship):
      rules_version = '2';
      service cloud.firestore {
        match /databases/{database}/documents {
          match /todos/{doc} {
            allow read, write: if true;
          }
        }
      }
    */
  </script>
</body>
</html>
